{
  "title": "Deployment Patterns",
  "objectives": [
    "Choose between serverless and container deployment models based on requirements",
    "Implement blue-green and canary deployment strategies for safe rollouts",
    "Configure infrastructure as code for repeatable agent deployments"
  ],
  "content": "# Deployment Patterns for AgentCore\n\nDeploying agents to production requires careful consideration of reliability, scalability, and rollback capabilities. AgentCore supports multiple deployment patterns to match your operational requirements.\n\n## Deployment Models\n\n### Serverless (Recommended for Most Use Cases)\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                    Serverless Deployment                         │\n│                                                                  │\n│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐       │\n│  │   Request    │───>│  AgentCore   │───>│   Bedrock    │       │\n│  │              │    │   Runtime    │    │   Models     │       │\n│  └──────────────┘    └──────────────┘    └──────────────┘       │\n│                             │                                    │\n│                      Auto-scaled by                              │\n│                      AgentCore                                   │\n│                                                                  │\n│  Pros:                    Cons:                                  │\n│  - No infrastructure      - Less control                         │\n│  - Auto-scaling          - Cold starts                           │\n│  - Pay per use           - 15 min timeout limit                  │\n│  - Fast deployment       - Memory limits                         │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n```python\n# Serverless deployment configuration\nagent_config = {\n    \"deployment\": {\n        \"mode\": \"serverless\",\n        \"memory_mb\": 512,\n        \"timeout_seconds\": 300,\n        \"environment\": {\n            \"LOG_LEVEL\": \"INFO\",\n            \"ENABLE_TRACING\": \"true\"\n        }\n    }\n}\n\n# Deploy\nagentcore deploy --config agent_config.yaml\n```\n\n### Container-Based (For Custom Requirements)\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                    Container Deployment                          │\n│                                                                  │\n│  ┌──────────────┐    ┌──────────────────────────────────┐       │\n│  │   Request    │───>│        Your Container             │       │\n│  │              │    │   ┌─────────────────────────┐    │       │\n│  └──────────────┘    │   │   Agent Code +          │    │       │\n│                      │   │   Custom Dependencies   │    │       │\n│                      │   └─────────────────────────┘    │       │\n│                      │              │                    │       │\n│                      │      ┌───────┴───────┐           │       │\n│                      │      │ AgentCore SDK │           │       │\n│                      │      └───────────────┘           │       │\n│                      └──────────────────────────────────┘       │\n│                                                                  │\n│  Pros:                    Cons:                                  │\n│  - Full control           - More to manage                       │\n│  - Custom runtimes        - Manual scaling                       │\n│  - No timeout limits      - Higher base cost                     │\n│  - Any dependencies       - Container expertise needed           │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n```dockerfile\n# Dockerfile for container deployment\nFROM python:3.11-slim\n\nWORKDIR /app\n\n# Install dependencies\nCOPY requirements.txt .\nRUN pip install --no-cache-dir -r requirements.txt\n\n# Copy agent code\nCOPY src/ ./src/\n\n# Run agent\nCMD [\"python\", \"-m\", \"src.main\"]\n```\n\n## Deployment Strategies\n\n### Blue-Green Deployment\n\nMaintain two identical environments, switch traffic instantly:\n\n```\n┌────────────────────────────────────────────────────────────────┐\n│                      Blue-Green Deployment                      │\n│                                                                 │\n│  Step 1: Deploy to Green (inactive)                            │\n│  ┌─────────────┐                                                │\n│  │   Traffic   │──────────────>┌─────────────┐                 │\n│  │   Router    │               │  Blue (v1)  │ ← Live          │\n│  └─────────────┘               └─────────────┘                 │\n│                                ┌─────────────┐                 │\n│                                │ Green (v2)  │ ← Deploying     │\n│                                └─────────────┘                 │\n│                                                                 │\n│  Step 2: Switch traffic to Green                               │\n│  ┌─────────────┐               ┌─────────────┐                 │\n│  │   Traffic   │               │  Blue (v1)  │ ← Standby       │\n│  │   Router    │──────────────>┌─────────────┐                 │\n│  └─────────────┘               │ Green (v2)  │ ← Live          │\n│                                └─────────────┘                 │\n│                                                                 │\n│  Rollback: Switch back to Blue instantly                        │\n└────────────────────────────────────────────────────────────────┘\n```\n\n```python\n# Blue-green deployment script\nimport boto3\n\ndef blue_green_deploy(new_version: str):\n    # 1. Deploy new version to inactive environment\n    inactive_env = get_inactive_environment()\n    deploy_to_environment(inactive_env, new_version)\n    \n    # 2. Run smoke tests on inactive\n    if not run_smoke_tests(inactive_env):\n        raise DeploymentError(\"Smoke tests failed\")\n    \n    # 3. Switch traffic\n    switch_traffic(target=inactive_env)\n    \n    # 4. Monitor for errors\n    if error_rate_high(threshold=0.01, duration_minutes=5):\n        rollback()\n        raise DeploymentError(\"Error rate too high, rolled back\")\n    \n    print(f\"Deployment successful: {new_version}\")\n```\n\n### Canary Deployment\n\nGradually shift traffic to new version:\n\n```\n┌────────────────────────────────────────────────────────────────┐\n│                      Canary Deployment                          │\n│                                                                 │\n│  Stage 1: 5% traffic to canary                                 │\n│  ┌─────────────┐    95%    ┌─────────────┐                     │\n│  │   Traffic   │──────────>│   v1 (old)  │                     │\n│  │   Router    │    5%     ┌─────────────┐                     │\n│  └─────────────┘──────────>│ v2 (canary) │                     │\n│                            └─────────────┘                     │\n│                                                                 │\n│  Stage 2: 25% if metrics good                                  │\n│  Stage 3: 50% if still good                                    │\n│  Stage 4: 100% - complete rollout                              │\n│                                                                 │\n│  At any stage: automatic rollback if metrics degrade            │\n└────────────────────────────────────────────────────────────────┘\n```\n\n```python\nimport time\n\nclass CanaryDeployment:\n    def __init__(self, stages: list[int] = [5, 25, 50, 100]):\n        self.stages = stages\n        self.current_stage = 0\n    \n    def deploy(self, new_version: str):\n        deploy_canary(new_version)\n        \n        for percentage in self.stages:\n            print(f\"Stage: {percentage}% traffic to canary\")\n            set_traffic_split(canary_percentage=percentage)\n            \n            # Monitor for 10 minutes\n            if not self.monitor_health(duration_minutes=10):\n                print(f\"Issues detected at {percentage}%, rolling back\")\n                self.rollback()\n                return False\n            \n            print(f\"Stage {percentage}% passed\")\n        \n        print(\"Canary promoted to production\")\n        return True\n    \n    def monitor_health(self, duration_minutes: int) -> bool:\n        \"\"\"Compare canary metrics to baseline.\"\"\"\n        for _ in range(duration_minutes):\n            canary_error_rate = get_error_rate(\"canary\")\n            baseline_error_rate = get_error_rate(\"stable\")\n            \n            # Canary shouldn't be significantly worse\n            if canary_error_rate > baseline_error_rate * 1.5:\n                return False\n            \n            canary_latency = get_p95_latency(\"canary\")\n            baseline_latency = get_p95_latency(\"stable\")\n            \n            if canary_latency > baseline_latency * 1.3:\n                return False\n            \n            time.sleep(60)\n        \n        return True\n    \n    def rollback(self):\n        set_traffic_split(canary_percentage=0)\n        remove_canary()\n```\n\n## Infrastructure as Code\n\n### Terraform Configuration\n\n```hcl\n# main.tf - AgentCore deployment\nterraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n\nvariable \"agent_version\" {\n  description = \"Agent version to deploy\"\n  type        = string\n}\n\nvariable \"environment\" {\n  description = \"Deployment environment\"\n  type        = string\n  default     = \"production\"\n}\n\n# Agent runtime configuration\nresource \"aws_agentcore_runtime\" \"main\" {\n  name        = \"order-agent-${var.environment}\"\n  description = \"Order processing agent\"\n  \n  runtime_config {\n    memory_mb        = 512\n    timeout_seconds  = 300\n    min_instances    = 1\n    max_instances    = 100\n  }\n  \n  execution_role_arn = aws_iam_role.agent_execution.arn\n  \n  environment_variables = {\n    AGENT_VERSION = var.agent_version\n    ENVIRONMENT   = var.environment\n    LOG_LEVEL     = var.environment == \"production\" ? \"INFO\" : \"DEBUG\"\n  }\n  \n  tags = {\n    Environment = var.environment\n    ManagedBy   = \"terraform\"\n  }\n}\n\n# IAM role for agent execution\nresource \"aws_iam_role\" \"agent_execution\" {\n  name = \"agent-execution-${var.environment}\"\n  \n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [{\n      Effect = \"Allow\"\n      Principal = {\n        Service = \"bedrock-agentcore.amazonaws.com\"\n      }\n      Action = \"sts:AssumeRole\"\n    }]\n  })\n}\n\n# Permissions for agent\nresource \"aws_iam_role_policy\" \"agent_permissions\" {\n  name = \"agent-permissions\"\n  role = aws_iam_role.agent_execution.id\n  \n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Action = [\"bedrock:InvokeModel\"]\n        Resource = [\"arn:aws:bedrock:*::foundation-model/*\"]\n      },\n      {\n        Effect = \"Allow\"\n        Action = [\"dynamodb:GetItem\", \"dynamodb:PutItem\"]\n        Resource = [aws_dynamodb_table.agent_data.arn]\n      }\n    ]\n  })\n}\n\noutput \"agent_endpoint\" {\n  value = aws_agentcore_runtime.main.invoke_url\n}\n```\n\n### CI/CD Pipeline\n\n```yaml\n# .github/workflows/deploy.yml\nname: Deploy Agent\n\non:\n  push:\n    branches: [main]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      - uses: actions/setup-python@v4\n        with:\n          python-version: '3.11'\n      - run: pip install -e \".[test]\"\n      - run: pytest -m \"unit or integration\"\n  \n  deploy-staging:\n    needs: test\n    runs-on: ubuntu-latest\n    environment: staging\n    steps:\n      - uses: actions/checkout@v3\n      - uses: hashicorp/setup-terraform@v2\n      - run: |\n          terraform init\n          terraform apply -auto-approve \\\n            -var=\"environment=staging\" \\\n            -var=\"agent_version=${{ github.sha }}\"\n      - name: Run smoke tests\n        run: python scripts/smoke_test.py $STAGING_ENDPOINT\n  \n  deploy-production:\n    needs: deploy-staging\n    runs-on: ubuntu-latest\n    environment: production\n    steps:\n      - uses: actions/checkout@v3\n      - uses: hashicorp/setup-terraform@v2\n      - name: Canary deploy\n        run: |\n          python scripts/canary_deploy.py \\\n            --version ${{ github.sha }} \\\n            --stages 5,25,50,100 \\\n            --monitor-duration 10\n```\n\n## Environment Management\n\n```\n┌────────────────────────────────────────────────────────────────┐\n│                    Environment Progression                      │\n│                                                                 │\n│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐     │\n│  │   Dev   │───>│ Staging │───>│ Canary  │───>│  Prod   │     │\n│  └─────────┘    └─────────┘    └─────────┘    └─────────┘     │\n│                                                                 │\n│  • Auto deploy    • Manual gate   • Auto metrics  • Full prod  │\n│  • Mocked LLM     • Real LLM      • 5% traffic    • 100%       │\n│  • Test data      • Sanitized     • Prod data     • Prod data  │\n│                     data                                        │\n└────────────────────────────────────────────────────────────────┘\n```\n\n```python\n# config.py - Environment-specific configuration\nimport os\n\nENV = os.environ.get(\"ENVIRONMENT\", \"development\")\n\nCONFIG = {\n    \"development\": {\n        \"model\": \"claude-3-haiku\",  # Cheaper for dev\n        \"log_level\": \"DEBUG\",\n        \"enable_tracing\": True,\n        \"mock_tools\": True,\n    },\n    \"staging\": {\n        \"model\": \"claude-3-sonnet\",\n        \"log_level\": \"DEBUG\",\n        \"enable_tracing\": True,\n        \"mock_tools\": False,\n    },\n    \"production\": {\n        \"model\": \"claude-3-sonnet\",\n        \"log_level\": \"INFO\",\n        \"enable_tracing\": True,\n        \"mock_tools\": False,\n    }\n}\n\ndef get_config():\n    return CONFIG[ENV]\n```\n\n## Summary\n\nDeployment patterns for agents:\n\n1. **Serverless** - Default choice. Auto-scaling, pay-per-use, fast deployment\n2. **Container** - When you need custom runtimes or long-running processes\n3. **Blue-green** - Instant rollback capability, zero-downtime deployment\n4. **Canary** - Gradual rollout with automatic rollback on metric degradation\n5. **IaC** - Terraform/CloudFormation for repeatable, version-controlled infrastructure\n\nKey principle: **Make rollback easy**. Something will go wrong - plan for fast recovery."
}
