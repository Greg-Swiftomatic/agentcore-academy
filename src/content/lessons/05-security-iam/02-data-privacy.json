{
  "title": "Identity Service & Authentication",
  "objectives": [
    "Understand inbound vs outbound authentication patterns in AgentCore",
    "Configure OAuth flows for accessing external services on behalf of users",
    "Implement the delegation model for secure resource access"
  ],
  "content": "# Identity Service & Authentication\n\nAgentCore's Identity service handles the complex authentication challenges of AI agents: validating who's calling your agent and enabling your agent to act on behalf of users.\n\n## The Two Authentication Directions\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                      INBOUND AUTH                                │\n│               \"Who is calling my agent?\"                         │\n│                                                                  │\n│   ┌──────────┐     validates      ┌──────────────────────┐      │\n│   │  User/   │  ─────────────────>│    AgentCore         │      │\n│   │  Client  │                    │    Identity Service  │      │\n│   └──────────┘                    └──────────────────────┘      │\n│                                                                  │\n│   Mechanisms: IAM, OAuth tokens, API keys                        │\n└─────────────────────────────────────────────────────────────────┘\n\n┌─────────────────────────────────────────────────────────────────┐\n│                      OUTBOUND AUTH                               │\n│         \"How does my agent access external resources?\"           │\n│                                                                  │\n│   ┌──────────────────────┐     accesses     ┌──────────────┐    │\n│   │    AgentCore         │  ──────────────> │  External    │    │\n│   │    Agent Runtime     │                  │  Services    │    │\n│   └──────────────────────┘                  └──────────────┘    │\n│                                                                  │\n│   Mechanisms: AWS IAM, OAuth client credentials, delegated tokens│\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## Inbound Authentication\n\nInbound auth validates callers before they can invoke your agent:\n\n### IAM-Based Authentication\nFor AWS service-to-service calls:\n```python\n# Caller authenticates with IAM credentials\nimport boto3\n\nclient = boto3.client('bedrock-agent-runtime')\nresponse = client.invoke_agent(\n    agentId='your-agent-id',\n    sessionId='session-123',\n    inputText='Process this request'\n)\n# Identity service validates IAM permissions automatically\n```\n\n### OAuth Token Validation\nFor user-facing applications:\n```python\n# Agent validates incoming OAuth tokens\nfrom agentcore import Identity\n\nidentity = Identity()\n\n# Validate token from identity provider (Cognito, Okta, Entra)\nuser_context = identity.validate_token(\n    token=request.headers['Authorization'],\n    provider='cognito'\n)\n\n# user_context now contains validated user identity\nprint(f\"Request from: {user_context.user_id}\")\n```\n\n## Outbound Authentication\n\nOutbound auth enables your agent to access external resources:\n\n### AWS Resource Access (IAM-Based)\n```python\n# Agent's Runtime Execution Role grants access to AWS resources\n# No explicit auth code needed - IAM handles it\n\nimport boto3\ns3 = boto3.client('s3')  # Uses runtime execution role\ns3.get_object(Bucket='my-bucket', Key='data.json')\n```\n\n### External Service Access (OAuth)\nAgentCore supports both OAuth patterns:\n\n**2-Legged OAuth (Client Credentials)**\nFor service-to-service without user context:\n```python\nfrom agentcore import Identity\n\nidentity = Identity()\n\n# Get token for service account\ntoken = identity.get_client_credentials_token(\n    client_id='agent-service-account',\n    scope=['read:data', 'write:data']\n)\n\n# Use token to call external API\nresponse = requests.get(\n    'https://api.external-service.com/data',\n    headers={'Authorization': f'Bearer {token}'}\n)\n```\n\n**3-Legged OAuth (User Delegation)**\nFor acting on behalf of a user:\n```python\nfrom agentcore import Identity\n\nidentity = Identity()\n\n# Exchange user's token for delegated access\ndelegated_token = identity.get_delegated_token(\n    user_token=user_context.token,\n    target_service='salesforce',\n    scopes=['read:contacts', 'write:contacts']\n)\n\n# Agent now acts on behalf of the user\nresponse = requests.get(\n    'https://your-instance.salesforce.com/contacts',\n    headers={'Authorization': f'Bearer {delegated_token}'}\n)\n```\n\n## The Delegation Model\n\nAgentCore uses **delegation**, not **impersonation**:\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                     DELEGATION MODEL                         │\n│                                                              │\n│   User ──grants permission──> Agent ──acts with──> Service  │\n│                                     limited scope            │\n│                                                              │\n│   Key properties:                                            │\n│   - User explicitly consents to delegation                   │\n│   - Agent receives scoped token, not user credentials        │\n│   - Actions are auditable as \"agent on behalf of user\"       │\n│   - Delegation can be revoked at any time                    │\n└─────────────────────────────────────────────────────────────┘\n\n┌─────────────────────────────────────────────────────────────┐\n│              IMPERSONATION (NOT USED)                        │\n│                                                              │\n│   Agent ──becomes──> User ──appears as──> Service            │\n│                                                              │\n│   Problems:                                                  │\n│   - No visibility that agent is acting                       │\n│   - Agent has full user access                               │\n│   - Hard to audit or revoke                                  │\n└─────────────────────────────────────────────────────────────┘\n```\n\n### Implementing Delegation\n\n```python\nfrom agentcore import Identity, DelegationConfig\n\nidentity = Identity()\n\n# Configure what the agent can do on user's behalf\nconfig = DelegationConfig(\n    target_service='external-crm',\n    max_scopes=['read:contacts'],  # Limit what agent can access\n    time_limit_seconds=3600,        # Token expires in 1 hour\n    audit_all_actions=True          # Log every action\n)\n\n# Request delegation from user\ndelegation = identity.request_delegation(\n    user_context=user_context,\n    config=config\n)\n\nif delegation.approved:\n    # Agent can now act with delegated permissions\n    token = delegation.get_token()\n```\n\n## Token Management\n\nAgentCore handles token lifecycle:\n\n```python\nfrom agentcore import Identity, TokenStore\n\nidentity = Identity()\ntoken_store = TokenStore()  # Secure token storage\n\n# Store tokens securely\ntoken_store.save(\n    user_id=user_context.user_id,\n    service='salesforce',\n    token=delegated_token,\n    expires_at=delegation.expires_at\n)\n\n# Retrieve and refresh automatically\ntoken = token_store.get_valid_token(\n    user_id=user_context.user_id,\n    service='salesforce'\n)  # Automatically refreshes if expired\n```\n\n## Best Practices\n\n1. **Always use delegation over impersonation** - Maintain audit trails\n2. **Request minimum scopes** - Only ask for what you need\n3. **Set token expiration** - Short-lived tokens reduce risk\n4. **Validate inbound tokens on every request** - Don't cache validation\n5. **Use secure token storage** - Never log or expose tokens\n\n## Summary\n\nThe Identity service provides:\n- **Inbound auth**: Validate who calls your agent (IAM, OAuth)\n- **Outbound auth**: Enable resource access (AWS IAM, OAuth flows)\n- **Delegation model**: Act on behalf of users with limited, auditable permissions\n- **Token management**: Secure storage and automatic refresh\n\nThis separation of concerns lets you focus on agent logic while AgentCore handles the authentication complexity."
}
