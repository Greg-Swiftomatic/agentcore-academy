{
  "title": "Security Best Practices",
  "objectives": [
    "Apply least-privilege principles to AgentCore deployments",
    "Configure VPC endpoints and network isolation for agents",
    "Implement secrets management and audit logging"
  ],
  "content": "# Security Best Practices for AgentCore\n\nProduction AgentCore deployments require defense in depth: layered security controls that protect against different threat vectors.\n\n## Principle of Least Privilege\n\nGrant only the minimum permissions required:\n\n### Runtime Execution Role Scoping\n\n```json\n// BAD: Overly permissive\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [{\n    \"Effect\": \"Allow\",\n    \"Action\": \"*\",\n    \"Resource\": \"*\"\n  }]\n}\n\n// GOOD: Scoped to specific resources and actions\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"bedrock:InvokeModel\"\n      ],\n      \"Resource\": [\n        \"arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-sonnet*\"\n      ]\n    },\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:GetObject\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::my-agent-data/*\"\n      ],\n      \"Condition\": {\n        \"StringEquals\": {\n          \"s3:ExistingObjectTag/classification\": \"agent-accessible\"\n        }\n      }\n    }\n  ]\n}\n```\n\n### Permission Boundaries\n\nSet maximum permissions that can never be exceeded:\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"bedrock:*\",\n        \"s3:GetObject\",\n        \"dynamodb:GetItem\",\n        \"dynamodb:PutItem\"\n      ],\n      \"Resource\": \"*\"\n    },\n    {\n      \"Effect\": \"Deny\",\n      \"Action\": [\n        \"iam:*\",\n        \"organizations:*\",\n        \"s3:DeleteBucket\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}\n```\n\nAttach as permission boundary:\n```bash\naws iam put-role-permission-boundary \\\n  --role-name AgentRuntimeRole \\\n  --permissions-boundary arn:aws:iam::123456789012:policy/AgentPermissionBoundary\n```\n\n## Network Isolation\n\n### VPC Endpoints\n\nKeep traffic within AWS network:\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                        Your VPC                              │\n│                                                              │\n│  ┌──────────────┐     ┌──────────────────────────────────┐  │\n│  │   AgentCore  │     │       VPC Endpoints              │  │\n│  │   Runtime    │────>│  - bedrock.us-east-1             │  │\n│  │              │     │  - s3.us-east-1                  │  │\n│  └──────────────┘     │  - dynamodb.us-east-1            │  │\n│                       │  - secretsmanager.us-east-1      │  │\n│                       └──────────────────────────────────┘  │\n│                                    │                         │\n│                           (Private link - no internet)       │\n│                                    ▼                         │\n│                       ┌──────────────────────────────────┐  │\n│                       │         AWS Services             │  │\n│                       └──────────────────────────────────┘  │\n└─────────────────────────────────────────────────────────────┘\n```\n\n### Creating VPC Endpoints\n\n```bash\n# Bedrock endpoint\naws ec2 create-vpc-endpoint \\\n  --vpc-id vpc-123456 \\\n  --service-name com.amazonaws.us-east-1.bedrock \\\n  --vpc-endpoint-type Interface \\\n  --subnet-ids subnet-abc123 subnet-def456 \\\n  --security-group-ids sg-agent-endpoints\n\n# S3 Gateway endpoint (no additional cost)\naws ec2 create-vpc-endpoint \\\n  --vpc-id vpc-123456 \\\n  --service-name com.amazonaws.us-east-1.s3 \\\n  --vpc-endpoint-type Gateway \\\n  --route-table-ids rtb-123456\n```\n\n### Security Groups\n\n```json\n// Agent runtime security group\n{\n  \"GroupName\": \"agent-runtime-sg\",\n  \"Description\": \"Security group for AgentCore runtime\",\n  \"IpPermissions\": [\n    {\n      \"IpProtocol\": \"tcp\",\n      \"FromPort\": 443,\n      \"ToPort\": 443,\n      \"UserIdGroupPairs\": [\n        {\n          \"GroupId\": \"sg-vpc-endpoints\",\n          \"Description\": \"Allow HTTPS to VPC endpoints\"\n        }\n      ]\n    }\n  ],\n  \"IpPermissionsEgress\": [\n    {\n      \"IpProtocol\": \"tcp\",\n      \"FromPort\": 443,\n      \"ToPort\": 443,\n      \"UserIdGroupPairs\": [\n        {\n          \"GroupId\": \"sg-vpc-endpoints\"\n        }\n      ]\n    }\n  ]\n}\n// Note: No 0.0.0.0/0 rules - agent cannot reach internet directly\n```\n\n## Secrets Management\n\nNever hardcode secrets. Use AWS Secrets Manager:\n\n### Storing Secrets\n\n```bash\naws secretsmanager create-secret \\\n  --name agent/external-api-key \\\n  --secret-string '{\"api_key\": \"your-secret-key\"}' \\\n  --kms-key-id alias/agent-secrets-key\n```\n\n### Retrieving Secrets in Agent Code\n\n```python\nimport boto3\nimport json\nfrom functools import lru_cache\n\n@lru_cache(maxsize=32)\ndef get_secret(secret_name: str) -> dict:\n    \"\"\"Retrieve and cache secrets.\"\"\"\n    client = boto3.client('secretsmanager')\n    response = client.get_secret_value(SecretId=secret_name)\n    return json.loads(response['SecretString'])\n\n# Usage\ndef call_external_api():\n    secrets = get_secret('agent/external-api-key')\n    api_key = secrets['api_key']\n    # Use api_key for external calls\n```\n\n### Secret Rotation\n\n```python\n# Enable automatic rotation\naws secretsmanager rotate-secret \\\n  --secret-id agent/external-api-key \\\n  --rotation-lambda-arn arn:aws:lambda:us-east-1:123456789012:function:RotateSecret \\\n  --rotation-rules AutomaticallyAfterDays=30\n```\n\n## Audit Logging\n\nTrack all agent actions for security and compliance:\n\n### CloudTrail for API Calls\n\n```bash\n# Create trail for AgentCore API calls\naws cloudtrail create-trail \\\n  --name agent-audit-trail \\\n  --s3-bucket-name agent-audit-logs \\\n  --include-global-service-events \\\n  --is-multi-region-trail \\\n  --enable-log-file-validation\n\n# Event selectors for Bedrock\naws cloudtrail put-event-selectors \\\n  --trail-name agent-audit-trail \\\n  --event-selectors '[{\n    \"ReadWriteType\": \"All\",\n    \"IncludeManagementEvents\": true,\n    \"DataResources\": [{\n      \"Type\": \"AWS::Bedrock::Agent\",\n      \"Values\": [\"arn:aws:bedrock:*:*:agent/*\"]\n    }]\n  }]'\n```\n\n### Application-Level Logging\n\n```python\nimport logging\nimport json\nfrom datetime import datetime\n\nclass AuditLogger:\n    def __init__(self):\n        self.logger = logging.getLogger('agent-audit')\n        handler = logging.StreamHandler()  # CloudWatch picks this up\n        handler.setFormatter(logging.Formatter('%(message)s'))\n        self.logger.addHandler(handler)\n        self.logger.setLevel(logging.INFO)\n    \n    def log_action(self, action: str, user_id: str, details: dict):\n        audit_record = {\n            'timestamp': datetime.utcnow().isoformat(),\n            'action': action,\n            'user_id': user_id,\n            'agent_id': os.environ.get('AGENT_ID'),\n            'session_id': details.get('session_id'),\n            'tool_used': details.get('tool'),\n            'resource_accessed': details.get('resource'),\n            'outcome': details.get('outcome', 'success')\n        }\n        self.logger.info(json.dumps(audit_record))\n\n# Usage in agent code\naudit = AuditLogger()\n\ndef process_request(user_context, request):\n    audit.log_action(\n        action='tool_invocation',\n        user_id=user_context.user_id,\n        details={\n            'session_id': request.session_id,\n            'tool': 'database_query',\n            'resource': 'customers_table'\n        }\n    )\n```\n\n## Data Protection\n\n### Encryption at Rest\n\n```python\n# Use customer-managed KMS keys\nimport boto3\n\nkms = boto3.client('kms')\n\n# Create key for agent data\nkey_response = kms.create_key(\n    Description='AgentCore data encryption key',\n    KeyUsage='ENCRYPT_DECRYPT',\n    KeySpec='SYMMETRIC_DEFAULT',\n    Tags=[{'TagKey': 'Purpose', 'TagValue': 'agent-data'}]\n)\n\n# Use for S3 bucket\naws s3api put-bucket-encryption \\\n  --bucket agent-data-bucket \\\n  --server-side-encryption-configuration '{\n    \"Rules\": [{\n      \"ApplyServerSideEncryptionByDefault\": {\n        \"SSEAlgorithm\": \"aws:kms\",\n        \"KMSMasterKeyID\": \"alias/agent-data-key\"\n      }\n    }]\n  }'\n```\n\n### Encryption in Transit\n\nAgentCore enforces TLS 1.2+ for all connections. For additional security:\n\n```python\n# Enforce TLS 1.2 minimum in agent code\nimport ssl\nimport urllib3\n\nhttp = urllib3.PoolManager(\n    ssl_version=ssl.PROTOCOL_TLS,\n    ssl_minimum_version=ssl.TLSVersion.TLSv1_2\n)\n```\n\n## Security Checklist\n\n```\n[ ] IAM\n    [ ] Runtime role follows least privilege\n    [ ] Permission boundaries set\n    [ ] No wildcard permissions\n    [ ] Trust policy locked to bedrock-agentcore.amazonaws.com\n\n[ ] Network\n    [ ] VPC endpoints for AWS services\n    [ ] Security groups restrict traffic\n    [ ] No unnecessary internet access\n\n[ ] Secrets\n    [ ] All secrets in Secrets Manager\n    [ ] Automatic rotation enabled\n    [ ] KMS encryption for secrets\n\n[ ] Audit\n    [ ] CloudTrail enabled\n    [ ] Application audit logging\n    [ ] Log retention policies set\n\n[ ] Data\n    [ ] Encryption at rest (KMS)\n    [ ] Encryption in transit (TLS 1.2+)\n    [ ] Data classification applied\n```\n\n## Summary\n\nProduction security requires:\n\n1. **Least privilege**: Scope permissions to exactly what's needed\n2. **Network isolation**: VPC endpoints, security groups, no unnecessary internet\n3. **Secrets management**: Never hardcode, use Secrets Manager with rotation\n4. **Audit logging**: Track all actions for security and compliance\n5. **Data protection**: Encrypt at rest and in transit with customer-managed keys\n\nThese controls work together as defense in depth - no single control is sufficient alone."
}
