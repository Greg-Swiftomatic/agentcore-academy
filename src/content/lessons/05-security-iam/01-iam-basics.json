{
  "title": "IAM for AgentCore",
  "objectives": [
    "Understand the two-role architecture: Developer and Runtime Execution roles",
    "Configure IAM permissions for deploying and running agents",
    "Apply least-privilege principles to production deployments"
  ],
  "content": "# IAM for AgentCore\n\nAgentCore requires specific IAM permissions at two levels: permissions for developers who deploy agents, and permissions for the agents themselves when running.\n\n## The Two-Role Architecture\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                    Developer/Caller                          │\n│            (deploys and manages agents)                      │\n│                                                              │\n│  ┌─────────────────────────────────────────────────────┐    │\n│  │     Developer/Caller Permissions                     │    │\n│  │  - IAM role management                               │    │\n│  │  - CodeBuild project access                          │    │\n│  │  - ECR repository access                             │    │\n│  │  - S3 access for deployments                         │    │\n│  │  - BedrockAgentCoreFullAccess                        │    │\n│  └─────────────────────────────────────────────────────┘    │\n└─────────────────────────────┬───────────────────────────────┘\n                              │\n                              ▼ deploys\n┌─────────────────────────────────────────────────────────────┐\n│                AgentCore Runtime                             │\n│              (executes your agent)                           │\n│                                                              │\n│  ┌─────────────────────────────────────────────────────┐    │\n│  │     Runtime Execution Role                           │    │\n│  │  - ECR image access                                  │    │\n│  │  - CloudWatch logs                                   │    │\n│  │  - Bedrock model invocation                          │    │\n│  │  - X-Ray telemetry                                   │    │\n│  │  - (Your custom resources: S3, DynamoDB, etc.)       │    │\n│  └─────────────────────────────────────────────────────┘    │\n└─────────────────────────────────────────────────────────────┘\n```\n\n## Developer/Caller Permissions\n\nDevelopers using the AgentCore CLI need permissions to create roles, manage CodeBuild projects, and deploy agents.\n\n### Required Managed Policies\n\n```\nBedrockAgentCoreFullAccess\nAmazonBedrockFullAccess (for model access)\n```\n\n### Custom Caller Policy\n\nFor more granular control, use this policy:\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"IAMRoleManagement\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"iam:CreateRole\",\n        \"iam:DeleteRole\",\n        \"iam:GetRole\",\n        \"iam:PutRolePolicy\",\n        \"iam:DeleteRolePolicy\",\n        \"iam:AttachRolePolicy\",\n        \"iam:DetachRolePolicy\"\n      ],\n      \"Resource\": [\n        \"arn:aws:iam::*:role/*BedrockAgentCore*\"\n      ]\n    },\n    {\n      \"Sid\": \"CodeBuildAccess\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"codebuild:StartBuild\",\n        \"codebuild:BatchGetBuilds\",\n        \"codebuild:CreateProject\",\n        \"codebuild:UpdateProject\"\n      ],\n      \"Resource\": [\n        \"arn:aws:codebuild:*:*:project/bedrock-agentcore-*\"\n      ]\n    },\n    {\n      \"Sid\": \"ECRAccess\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"ecr:CreateRepository\",\n        \"ecr:DescribeRepositories\",\n        \"ecr:PutImage\",\n        \"ecr:BatchCheckLayerAvailability\"\n      ],\n      \"Resource\": [\n        \"arn:aws:ecr:*:*:repository/bedrock-agentcore-*\"\n      ]\n    }\n  ]\n}\n```\n\n## Runtime Execution Role\n\nThis role is assumed by AgentCore Runtime to execute your agent. It needs permissions for everything your agent does.\n\n### Trust Policy\n\nAllow AgentCore to assume this role:\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"bedrock-agentcore.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"aws:SourceAccount\": \"123456789012\"\n        },\n        \"ArnLike\": {\n          \"aws:SourceArn\": \"arn:aws:bedrock-agentcore:us-east-1:123456789012:*\"\n        }\n      }\n    }\n  ]\n}\n```\n\n### Base Permissions\n\nEvery agent needs these baseline permissions:\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"ECRImageAccess\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"ecr:BatchGetImage\",\n        \"ecr:GetDownloadUrlForLayer\"\n      ],\n      \"Resource\": \"arn:aws:ecr:*:*:repository/*\"\n    },\n    {\n      \"Sid\": \"ECRAuth\",\n      \"Effect\": \"Allow\",\n      \"Action\": \"ecr:GetAuthorizationToken\",\n      \"Resource\": \"*\"\n    },\n    {\n      \"Sid\": \"CloudWatchLogs\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"logs:CreateLogGroup\",\n        \"logs:CreateLogStream\",\n        \"logs:PutLogEvents\"\n      ],\n      \"Resource\": \"arn:aws:logs:*:*:log-group:/aws/bedrock-agentcore/*\"\n    },\n    {\n      \"Sid\": \"BedrockModels\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"bedrock:InvokeModel\",\n        \"bedrock:InvokeModelWithResponseStream\"\n      ],\n      \"Resource\": \"arn:aws:bedrock:*::foundation-model/*\"\n    },\n    {\n      \"Sid\": \"XRayTelemetry\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"xray:PutTraceSegments\",\n        \"xray:PutTelemetryRecords\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}\n```\n\n## Adding Custom Permissions\n\nIf your agent uses other AWS services, add those permissions to the Runtime Execution Role.\n\n### DynamoDB Access\n\n```json\n{\n  \"Sid\": \"DynamoDBAccess\",\n  \"Effect\": \"Allow\",\n  \"Action\": [\n    \"dynamodb:GetItem\",\n    \"dynamodb:PutItem\",\n    \"dynamodb:Query\"\n  ],\n  \"Resource\": \"arn:aws:dynamodb:*:*:table/YourTable\"\n}\n```\n\n### S3 Access\n\n```json\n{\n  \"Sid\": \"S3Access\",\n  \"Effect\": \"Allow\",\n  \"Action\": [\n    \"s3:GetObject\",\n    \"s3:PutObject\"\n  ],\n  \"Resource\": [\n    \"arn:aws:s3:::your-bucket\",\n    \"arn:aws:s3:::your-bucket/*\"\n  ]\n}\n```\n\n### Secrets Manager Access\n\n```json\n{\n  \"Sid\": \"SecretsAccess\",\n  \"Effect\": \"Allow\",\n  \"Action\": \"secretsmanager:GetSecretValue\",\n  \"Resource\": \"arn:aws:secretsmanager:*:*:secret:my-agent/*\"\n}\n```\n\n## Auto Role Creation\n\nThe AgentCore toolkit can automatically create roles:\n\n```bash\n# Auto-creates Runtime Execution Role\nagentcore configure -e my_agent.py\nagentcore launch\n```\n\nAuto-created roles follow this naming convention:\n- **Runtime Role**: `AmazonBedrockAgentCoreSDKRuntime-{region}-{hash}`\n- **CodeBuild Role**: `AmazonBedrockAgentCoreSDKCodeBuild-{region}-{hash}`\n\n## Using Existing Roles\n\nFor production, create roles manually and specify them:\n\n```bash\nagentcore configure -e my_agent.py --execution-role arn:aws:iam::123456789012:role/MyAgentRole\n```\n\n## Production: Least Privilege\n\nScope down permissions for production:\n\n### Before (Development)\n```json\n{\n  \"Action\": \"bedrock:InvokeModel\",\n  \"Resource\": \"arn:aws:bedrock:*::foundation-model/*\"\n}\n```\n\n### After (Production)\n```json\n{\n  \"Action\": \"bedrock:InvokeModel\",\n  \"Resource\": [\n    \"arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-5-sonnet-*\"\n  ]\n}\n```\n\n## Verifying Permissions\n\nTest your setup:\n\n```bash\n# Check your identity\naws sts get-caller-identity\n\n# Verify Bedrock access\naws bedrock list-foundation-models --region us-east-1\n\n# Verify AgentCore access\nagentcore list\n```\n\n## Common Permission Errors\n\n### \"Access Denied\" on InvokeModel\n- Model not enabled in Bedrock console\n- Runtime role missing bedrock:InvokeModel permission\n- Wrong region specified\n\n### \"Unable to assume role\"\n- Trust policy doesn't include bedrock-agentcore.amazonaws.com\n- Missing Condition block in trust policy\n\n### \"ECR image not found\"\n- Runtime role missing ecr:BatchGetImage permission\n- Image doesn't exist in the specified repository\n\n## Key Takeaways\n\n1. **Two roles needed** - Developer role for deployment, Runtime role for execution\n2. **Trust policy is critical** - Runtime role must trust bedrock-agentcore.amazonaws.com\n3. **Start broad, scope down** - Use auto-creation for development, manual roles for production\n4. **Add custom permissions** - If your agent uses DynamoDB, S3, etc., add those permissions to the Runtime role"
}
